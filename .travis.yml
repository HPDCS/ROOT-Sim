language: c
os: linux
compiler: clang
dist: bionic

git:
  depth: 1

branches:
  except:
  - gh-pages

jobs:
  include:
    - addons:
       apt:
         packages:
          - clang-7
          - libclang-7-dev
          - llvm-7
          - llvm-7-dev
          - llvm-7-tools
          - libc++-7-dev
          - libc++abi-7-dev
          - mpich
          - libmpich-dev
          - lcov
          - python3-setuptools
          - python3-pip
          - jq
      env:
          - CC=mpicc
          - MPICH_CC=clang-7
          - CXX=clang++-7
    - addons:
       apt:
         packages:
          - clang-8
          - libclang-8-dev
          - llvm-8
          - llvm-8-dev
          - llvm-8-tools
          - libc++-8-dev
          - libc++abi-8-dev
          - mpich
          - libmpich-dev
          - doxygen
          - graphviz
      env:
          - CC=mpicc
          - MPICH_CC=clang-8
          - CXX=clang++-8
    - addons:
       sources:
        - sourceline: 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-9 main'
          key_url: 'https://apt.llvm.org/llvm-snapshot.gpg.key'
       apt:
         packages:
          - clang-9
          - libclang-9-dev
          - llvm-9
          - llvm-9-dev
          - llvm-9-tools
          - libc++-9-dev
          - libc++abi-9-dev
          - mpich
          - libmpich-dev
          - doxygen
          - graphviz
      env:
          - CC=mpicc
          - MPICH_CC=clang-9
          - CXX=clang++-9
          - deploy=true
     
env:
  global:
    secure: JvReZBJUpYGDbrSbsshimBKu2HXLA3nniHSTVdTdWCOIo2mwAAU/qBh3gqExTsihdI9/6OaK4RoL6kvgRoKZ4HllkKxHtP5ttKpVguRYAzWLJWnlJm7s7v1AEs1txdQLa9kgGGHJsNnMYI+dX5BCG+huVdI+phf8BhVcCi04EGw=

before_install:
  - pip3 install --upgrade pip
  - pip3 install --user $(whoami) coverxygen

before_script:
  - mpiexec --version
  - mpicc --version
  - $CC --version
  - gcov-7 --version
  - gcov --version
  - m4 --version
  - automake --version
  - autoconf --version
  - llvm-config --cppflags

script:
  - ./scripts/travis-build.sh
  - ./scripts/tests.sh
  - ./scripts/travis-build-doc.sh

after_success:
  - bash <(curl -s https://codecov.io/bash) -x gcov-7

# Documentation autodeploy script
deploy:
 - provider: pages
   token: $DOCS_SECRET
   keep_history: false
   local_dir: ROOT-Sim
   verbose: true
   on:
     branch: master
     condition: $deploy = true

 - provider: pages
   token: $DOCS_SECRET
   keep_history: false
   local_dir: ROOT-Sim
   verbose: true
   on:
     branch: develop
     condition: $deploy = true

