language: c
compiler: gcc
sudo: false

git:
  depth: 1
branches:
  except:
   - gh-pages

matrix:
  include:
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-8
            - mpich
            - libmpich-dev

before_install:
  - export CC=mpicc
  - export MPICH_CC=gcc-8

before_script:
  - mpicc --version
  - $CC --version
  - m4 --version
  - automake --version
  - autoconf --version

script:
  - ./autogen.sh
  - ./configure --enable-mpi --enable-coverage --prefix=$HOME
  - make
  - make install
  - export PATH=$PATH:$HOME
  - cd models/pcs/
  - rootsim-cc *.c -o model
  - cd ../..
  - cp models/pcs/model .
  - mpiexec --np 2 ./model --np 2 --nprc 16 --no-core-binding
  - ./model --sequential --nprc 1

after_success:
  - bash <(curl -s https://codecov.io/bash)
