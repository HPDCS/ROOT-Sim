language: c
compiler: gcc
sudo: false

git:
  depth: 1

branches:
  except:
  - gh-pages

matrix:
  include:
  - os: linux
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - g++-8
        - mpich
        - libmpich-dev
        - doxygen
        - graphviz

env:
  matrix:
    secure: JvReZBJUpYGDbrSbsshimBKu2HXLA3nniHSTVdTdWCOIo2mwAAU/qBh3gqExTsihdI9/6OaK4RoL6kvgRoKZ4HllkKxHtP5ttKpVguRYAzWLJWnlJm7s7v1AEs1txdQLa9kgGGHJsNnMYI+dX5BCG+huVdI+phf8BhVcCi04EGw=

before_install:
  - export CC=mpicc
  - export MPICH_CC=gcc-8

before_script:
  - mpicc --version
  - $CC --version
  - m4 --version
  - automake --version
  - autoconf --version

script:
  - ./autogen.sh
  - ./configure --enable-mpi --enable-coverage --prefix=$HOME
  - make
  - make install
  - export PATH=$PATH:$HOME
  - ./tests.sh
  - # Build the docs
  - cd docs
  - make
  - cd ..
  - git clone --depth=1 -b gh-pages --single-branch https://github.com/HPDCS/ROOT-Sim.git
  - mkdir -p ROOT-Sim/docs/
  - mv docs/html ROOT-Sim/docs/$TRAVIS_BRANCH
  - cp README.md ROOT-Sim

after_success:
  - bash <(curl -s https://codecov.io/bash)

# Documentation autodeploy script
deploy:
  provider: pages
  skip-cleanup: true
  github-token: $DOCS_SECRET
  keep-history: true
  local-dir: ROOT-Sim
  verbose: true
  on:
    branch: master

deploy:
  provider: pages
  skip-cleanup: true
  github-token: $DOCS_SECRET
  keep-history: true
  local-dir: ROOT-Sim
  verbose: true
  on:
    branch: develop
